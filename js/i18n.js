// ==================== i18n SYSTEM ====================
var translations = {
    ru: {
        loginTitle: '–í—Ö–æ–¥',
        registerTitle: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
        loginSubtitle: '–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç',
        registerSubtitle: '–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç',
        loginBtn: '–í–æ–π—Ç–∏',
        registerBtn: '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç',
        noAccount: '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <b>–°–æ–∑–¥–∞—Ç—å</b>',
        hasAccount: '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <b>–í–æ–π—Ç–∏</b>',
        namePlaceholder: '–ò–º—è',
        passwordPlaceholder: '–ü–∞—Ä–æ–ª—å',
        fillAllFields: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è',
        passwordMin8: '–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤',
        invalidPasswordChars: '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –ø–∞—Ä–æ–ª–µ',
        enterName: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è',
        nameMax16: '–ò–º—è –º–∞–∫—Å–∏–º—É–º 16 —Å–∏–º–≤–æ–ª–æ–≤',
        nameOnlyLetters: '–ò–º—è: —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –ø—Ä–æ–±–µ–ª—ã',
        chats: '–ß–∞—Ç—ã',
        settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        profileTab: '–ü—Ä–æ—Ñ–∏–ª—å',
        notifications: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
        privacy: '–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å',
        language: '–Ø–∑—ã–∫',
        logout: '–í—ã–π—Ç–∏',
        langRussian: '–†—É—Å—Å–∫–∏–π',
        langEnglish: 'English',
        online: '–í —Å–µ—Ç–∏',
        aboutMe: '–û —Å–µ–±–µ',
        username: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞',
        accountVerified: '–ê–∫–∫–∞—É–Ω—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω',
        accountStatus: '–°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞',
        writeMessage: '–ù–∞–ø–∏—Å–∞—Ç—å',
        msgSending: '–°–æ–æ–±—â–µ–Ω–∏–µ –µ—â—ë –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è',
        msgDeleted: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–æ',
        cancel: '–û—Ç–º–µ–Ω–∞',
        edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
        save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        avatar: '–ê–≤–∞—Ç–∞—Ä',
        bannerLabel: '–ë–∞–Ω–Ω–µ—Ä',
        clickToUpload: '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏',
        nameLabel: '–ò–º—è',
        yourName: '–í–∞—à–µ –∏–º—è',
        tellAboutYourself: '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...',
        animatedEmoji: '–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏',
        uploadTgsJson: '–ó–∞–≥—Ä—É–∑–∏—Ç—å TGS / JSON',
        emojiLoaded: '–≠–º–æ–¥–∑–∏ –∑–∞–≥—Ä—É–∂–µ–Ω',
        currentEmoji: '–¢–µ–∫—É—â–∏–π —ç–º–æ–¥–∑–∏',
        delete: '–£–¥–∞–ª–∏—Ç—å',
        change: '–ò–∑–º–µ–Ω–∏—Ç—å',
        enterNameErr: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è',
        max16: '–ú–∞–∫—Å–∏–º—É–º 16 —Å–∏–º–≤–æ–ª–æ–≤',
        onlyLettersSpaces: '–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –ø—Ä–æ–±–µ–ª—ã',
        min5: '–ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤',
        max20: '–ú–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤',
        cantStartDigit: '–ù–µ –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ü–∏—Ñ—Ä—ã',
        onlyAzDigits: '–¢–æ–ª—å–∫–æ a-z, 0-9. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –±—É–∫–≤—ã',
        cantDeleteUsername: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å, —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å',
        max40: '–ú–∞–∫—Å–∏–º—É–º 40 —Å–∏–º–≤–æ–ª–æ–≤',
        usernameTaken: '–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ',
        errorPrefix: '–û—à–∏–±–∫–∞: ',
        searchByUsername: '–ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É',
        noMessages: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π',
        writeFirstMessage: '–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
        noChats: '–ù–µ—Ç —á–∞—Ç–æ–≤',
        findUserByUsername: '–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>—á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É',
        noChatsMsg: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π',
        messagePlaceholder: '–°–æ–æ–±—â–µ–Ω–∏–µ...',
        nothingFound: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        wasJustNow: '–±—ã–ª(–∞) —Ç–æ–ª—å–∫–æ —á—Ç–æ',
        wasRecently: '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ',
        wasMinAgo: '–±—ã–ª(–∞) {n} –º–∏–Ω. –Ω–∞–∑–∞–¥',
        was1MinAgo: '–±—ã–ª(–∞) 1 –º–∏–Ω. –Ω–∞–∑–∞–¥',
        was1HrAgo: '–±—ã–ª(–∞) 1 —á. –Ω–∞–∑–∞–¥',
        wasHrsAgo: '–±—ã–ª(–∞) {n} —á. –Ω–∞–∑–∞–¥',
        was1DayAgo: '–±—ã–ª(–∞) 1 –¥. –Ω–∞–∑–∞–¥',
        wasDaysAgo: '–±—ã–ª(–∞) {n} –¥–Ω. –Ω–∞–∑–∞–¥',
        was1WeekAgo: '–±—ã–ª(–∞) 1 –Ω–µ–¥. –Ω–∞–∑–∞–¥',
        wasWeeksAgo: '–±—ã–ª(–∞) {n} –Ω–µ–¥. –Ω–∞–∑–∞–¥',
        wasLongAgo: '–±—ã–ª(–∞) –¥–∞–≤–Ω–æ',
        inOnline: '–≤ —Å–µ—Ç–∏',
        close: '–ó–∞–∫—Ä—ã—Ç—å',
        howToGet: '–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å',
        request: '–ó–∞—è–≤–∫–∞',
        send: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        verifyDescription: '–û–ø–∏—à–∏—Ç–µ, –ø–æ—á–µ–º—É –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã –∏–ª–∏ –ø—Ä–∏—á–∏–Ω—ã –≤–∞—à–µ–π –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏/–∑–Ω–∞—á–∏–º–æ—Å—Ç–∏.',
        reasonPlaceholder: '–ü—Ä–∏—á–∏–Ω–∞...',
        verifiedAccount: '{name} ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç',
        sending: '–û—Ç–ø—Ä–∞–≤–∫–∞...',
        noRequests: '–ù–µ—Ç –∑–∞—è–≤–æ–∫',
        noNotifications: '–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',
        requestFrom: '–ó–∞—è–≤–∫–∞ –æ—Ç {name}',
        accept: '–ü—Ä–∏–Ω—è—Ç—å',
        reject: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å',
        rejectReason: '–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞',
        specifyRejectReason: '–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞...',
        verification: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è',
        verifyApproved: '–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –æ–¥–æ–±—Ä–µ–Ω–∞!',
        verifyRejected: '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –ü—Ä–∏—á–∏–Ω–∞: {reason}',
        thisIsYou: '–≠—Ç–æ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å',
        noSuchAccount: '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º',
        msgNotFound: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        fileCorrupted: '–§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω',
        formatNotRecognized: '–§–æ—Ä–º–∞—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω',
        invalidData: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
        notLottie: '–ù–µ Lottie-–∞–Ω–∏–º–∞—Ü–∏—è',
        noLayers: '–ù–µ—Ç —Å–ª–æ—ë–≤ –∞–Ω–∏–º–∞—Ü–∏–∏',
        gifNotSupported: 'GIF –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
        quote: '–¶–∏—Ç–∞—Ç–∞',
        langChanged: '–Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω',
        botCheck: '–ü—Ä–æ–≤–µ—Ä–∫–∞...',
        botFailed: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞',
        darkMode: '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞'
    },
    en: {
        loginTitle: 'Login',
        registerTitle: 'Registration',
        loginSubtitle: 'Sign in to your account',
        registerSubtitle: 'Create an account',
        loginBtn: 'Sign In',
        registerBtn: 'Create Account',
        noAccount: 'No account? <b>Create</b>',
        hasAccount: 'Already have an account? <b>Sign In</b>',
        namePlaceholder: 'Name',
        passwordPlaceholder: 'Password',
        fillAllFields: 'Fill in all fields',
        passwordMin8: 'Password must be at least 8 characters',
        invalidPasswordChars: 'Invalid characters in password',
        enterName: 'Enter your name',
        nameMax16: 'Name max 16 characters',
        nameOnlyLetters: 'Name: only letters and spaces',
        chats: 'Chats',
        settings: 'Settings',
        profileTab: 'Profile',
        notifications: 'Notifications',
        privacy: 'Privacy',
        language: 'Language',
        logout: 'Log Out',
        langRussian: '–†—É—Å—Å–∫–∏–π',
        langEnglish: 'English',
        online: 'Online',
        aboutMe: 'About',
        username: 'Username',
        loading: 'Loading',
        accountVerified: 'Account is officially verified',
        accountStatus: 'Account status',
        writeMessage: 'Message',
        msgSending: 'Message is still sending',
        msgDeleted: 'Message not found or deleted',
        cancel: 'Cancel',
        edit: 'Edit',
        save: 'Save',
        avatar: 'Avatar',
        bannerLabel: 'Banner',
        clickToUpload: 'Click to upload',
        nameLabel: 'Name',
        yourName: 'Your name',
        tellAboutYourself: 'Tell about yourself...',
        animatedEmoji: 'Animated emoji',
        uploadTgsJson: 'Upload TGS / JSON',
        emojiLoaded: 'Emoji loaded',
        currentEmoji: 'Current emoji',
        delete: 'Delete',
        change: 'Change',
        enterNameErr: 'Enter name',
        max16: 'Max 16 characters',
        onlyLettersSpaces: 'Only letters and spaces',
        min5: 'Min 5 characters',
        max20: 'Max 20 characters',
        cantStartDigit: 'Cannot start with a digit',
        onlyAzDigits: 'Only a-z, 0-9. Must start with letter',
        cantDeleteUsername: 'Cannot delete, only change',
        max40: 'Max 40 characters',
        usernameTaken: 'This username is taken',
        errorPrefix: 'Error: ',
        searchByUsername: 'Search by username',
        noMessages: 'No messages',
        writeFirstMessage: 'Write the first message',
        noChats: 'No chats',
        findUserByUsername: 'Find a user<br>by searching username',
        noChatsMsg: 'No messages',
        messagePlaceholder: 'Message...',
        nothingFound: 'Nothing found',
        user: 'User',
        wasJustNow: 'just now',
        wasRecently: 'recently',
        wasMinAgo: '{n} min ago',
        was1MinAgo: '1 min ago',
        was1HrAgo: '1 hr ago',
        wasHrsAgo: '{n} hrs ago',
        was1DayAgo: '1 day ago',
        wasDaysAgo: '{n} days ago',
        was1WeekAgo: '1 week ago',
        wasWeeksAgo: '{n} weeks ago',
        wasLongAgo: 'long ago',
        inOnline: 'online',
        close: 'Close',
        howToGet: 'How to get',
        request: 'Request',
        send: 'Send',
        verifyDescription: 'Describe why your account should be officially verified. Provide links to your resources or reasons for your popularity/significance.',
        reasonPlaceholder: 'Reason...',
        verifiedAccount: '{name} ‚Äî verified account',
        sending: 'Sending...',
        noRequests: 'No requests',
        noNotifications: 'No notifications',
        requestFrom: 'Request from {name}',
        accept: 'Accept',
        reject: 'Reject',
        rejectReason: 'Rejection reason',
        specifyRejectReason: 'Specify the reason for rejection...',
        verification: 'Verification',
        verifyApproved: 'Your verification request has been approved!',
        verifyRejected: 'Request rejected. Reason: {reason}',
        thisIsYou: 'This is your profile',
        noSuchAccount: 'No account with this username',
        msgNotFound: 'Message not found',
        fileCorrupted: 'File corrupted',
        formatNotRecognized: 'Format not recognized',
        invalidData: 'Invalid data',
        notLottie: 'Not a Lottie animation',
        noLayers: 'No animation layers',
        gifNotSupported: 'GIF is not supported',
        quote: 'Quote',
        langChanged: 'Language changed',
        botCheck: 'Checking...',
        botFailed: 'Verification failed, try again',
        darkMode: 'Dark Mode'
    }
};

var currentLang = 'ru';

function t(key, params) {
    var str = (translations[currentLang] && translations[currentLang][key]) || (translations.ru && translations.ru[key]) || key;
    if (params) {
        Object.keys(params).forEach(function (k) {
            str = str.replace('{' + k + '}', params[k]);
        });
    }
    return str;
}

function applyI18n() {
    document.querySelectorAll('[data-i18n]').forEach(function (el) {
        el.textContent = t(el.getAttribute('data-i18n'));
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function (el) {
        el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
    });
    var sub = document.getElementById('langSubtitle');
    if (sub) sub.textContent = currentLang === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English';
    updateAuthTexts();
    document.documentElement.lang = currentLang;
}

function updateAuthTexts() {
    document.getElementById('authTitle').textContent = isRegister ? t('registerTitle') : t('loginTitle');
    document.getElementById('authSubtitle').textContent = isRegister ? t('registerSubtitle') : t('loginSubtitle');
    document.getElementById('authBtn').textContent = isRegister ? t('registerBtn') : t('loginBtn');
    document.getElementById('authSwitch').innerHTML = isRegister ? t('hasAccount') : t('noAccount');
    document.getElementById('authName').placeholder = t('namePlaceholder');
    document.getElementById('authPassword').placeholder = t('passwordPlaceholder');
}

function loadLang() {
    var saved = localStorage.getItem('app_lang');
    if (saved && translations[saved]) {
        currentLang = saved;
    } else {
        currentLang = 'ru';
    }
}

function saveLang(lang) {
    currentLang = lang;
    localStorage.setItem('app_lang', lang);
    if (authUid) {
        sb.from('profiles').update({ language: lang }).eq('id', myUid()).then(function () { });
    }
}

async function loadLangFromServer() {
    if (!authUid) return;
    try {
        var res = await sb.from('profiles').select('language').eq('id', myUid()).single();
        if (res.data && res.data.language && translations[res.data.language]) {
            currentLang = res.data.language;
            localStorage.setItem('app_lang', currentLang);
            applyI18n();
        }
    } catch (e) { }
}

function openLangModal() {
    renderLangList();
    document.getElementById('langModal').classList.add('open');
}

function closeLangModal() {
    document.getElementById('langModal').classList.remove('open');
}

function renderLangList() {
    var langs = [
        { code: 'ru', flag: 'üá∑üá∫', name: '–†—É—Å—Å–∫–∏–π' },
        { code: 'en', flag: 'üá¨üáß', name: 'English' }
    ];
    var html = langs.map(function (l) {
        var sel = l.code === currentLang ? ' selected' : '';
        return '<div class="lang-option' + sel + '" onclick="selectLang(\'' + l.code + '\')">' +
            '<span class="lang-flag">' + l.flag + '</span>' +
            '<span class="lang-name">' + l.name + '</span>' +
            '<div class="lang-check">' + (l.code === currentLang ? '<svg width="10" height="10" fill="none" stroke="#fff" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' : '') + '</div>' +
            '</div>';
    }).join('');
    document.getElementById('langList').innerHTML = html;
}

function selectLang(lang) {
    if (lang === currentLang) { closeLangModal(); return; }
    saveLang(lang);
    applyI18n();
    renderLangList();
    renderChatList();
    applyProfile();
    renderProfileEmoji();
    showToast(t('langChanged'));
    setTimeout(closeLangModal, 300);
}
